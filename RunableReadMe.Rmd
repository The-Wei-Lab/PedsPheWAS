---
title: "PedPheWAS R package"
author: "Monika Grabowska"
date: "August 4, 2023"
output: html_document
---

## Introduction

The PedPheWAS R package is designed to perform phenome-wide association studies (PheWAS) using pediatric phecodes (Ped-Phecodes).

 This package was built based on the original PheWAS R package available at: https://github.com/PheWAS/PheWAS 
 
## Installation
To install the latest development version of the PedPheWAS R package, use the following import statements, or run the packageSetup function: 

```{r setup}
# install required packages 
install.packages(c("devtools","vroom","tidyverse","parallel")) devtools::install_github("xx /PedPheWAS")

```

## Tutorial 

This tutorial demonstrates how to use the PedPheWAS R package to perform a PheWAS analysis using simulated data.

### 1) Prepare and load input data


To perform a PheWAS, the user must provide three data frames: 1) a data frame containing patient ICD-9-CM and ICD-10-CM codes and code counts (or code index dates), 2) a data frame with patient sex (used to determine case/control/exclude status for sex-specific phecodes), and 3) a data frame containing the patient genotypes. 

An example of each of these data frames is provided below, showing the required column formatting.  

If you start by running the packageSetup function, these dataframes will be previously defined

```{r step1}
example_data_icd <- vroom::vroom("~/person_icd.csv",
.name = janitor::make_clean_names, delim = ",",
col_types = c(id = "i", vocabulary_id = "c", code = "c", count = "i"))

example_data_gender <- vroom::vroom("~/test_gender.csv",
.name = janitor::make_clean_names, delim = ",",
col_types = c(id = "i", sex = "c"))

example_data_genotypes <- vroom::vroom("~/test_genotypes.csv",
.name = janitor::make_clean_names, delim = ",",
col_types = c(id = "i", rs_example = "i"))

```

### 2) Mapping ICD-9-CM and ICD-10-CM codes to pediatric phecodes

The createPedPhenotypes() function maps the patient ICD-9-CM and ICD-10-CM codes to pediatric phecodes.

ped_phenotypes <- createPedPhenotypes(example_data_icd, example_data_gender)

The function returns a data frame of boolean phenotypes, in which the first column contains patient IDs and the remaining columns indicate case/control/exclude status (i.e., TRUE/FALSE/NA) for each phecode. 



A subset of the example output is shown below: 


```{r step2}
#*insert plot here*
```

### 3) Preparing data for PheWAS 

Join the patient genotype data to the boolean phenotypes generated by the createPedPhenotypes() function to create the data frame needed to perform PheWAS. If planning to adjust for covariates (e.g., age, gender), these should also be joined to the data frame.   

```{r step3}
df_full <- inner_join(example_data_genotypes, ped_phenotypes, by = "id")
df_full
```

### 4) Performing PheWAS 

The phewas_ext() function performs the PheWAS using the data frame with phenotype, genotype, and any covariate data. 

```{r step4a}
results <- phewas_ext(phenotypes=names(ped_phenotypes)[-1], genotypes=colnames(example_data_genotypes)[2], df_full)
```
A subset of the example output is shown below: 
```{r step4b}
results
```

### 5) Plotting PheWAS results

The results of the PheWAS can be visualized in a Manhattan plot using the plotManhattan() function. The Manhattan plot shows the negative log p-value of the associations, with phecodes arranged on the x-axis by disease category. Annotations can be added to the plot to highlight notable associations. 

a) Manhattan plot with annotations specified using annotate.level:

```{r step5a}
test_plot1 <- plotManhattan(results, annotate.phenotype = T, annotate.level = 0.005, y.axis.interval = 1)

test_plot1


```

b) Manhattan plot with annotations specified using annotate.list: 

```{r step5b}
test_plot2 <- plotManhattan(results, annotate.phenotype = T, annotate.list = c("622"), y.axis.interval = 1)

test_plot2


```

c) Manhattan plot without annotations: 
```{r step5c}

test_plot3 <- plotManhattan(results, annotate.phenotype = F, y.axis.interval = 1)

test_plot3


```


## Citation

**insert citations here**

